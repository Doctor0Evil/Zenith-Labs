name: ComplianceNexus Swarm Intelligence

on:
  push:
    paths:
      - '**/*.sai'
      - '**/*.SAI'
  pull_request:
    paths:
      - '**/*.sai'
      - '**/*.SAI'
  schedule:
    - cron: '*/15 * * * *' # every 15 minutes

concurrency:
  group: compliance-nexus-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: 6.0
  DATA_ENCRYPTION: web5.crypto.aes256-gcm

permissions:
  contents: read
  actions: read
  id-token: write
  checks: write

jobs:
  data_ingestion_validation:
    name: Data Ingestion & Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Ingest Web5 Intelligence Feeds
        run: |
          # Example command, replace with your actual ingestion tool
          .tools/dataingest --sources https://snyk.io/blog/github-malware-repositories-repo-confusion \
            https://apiiro.com/blog/malicious-code-campaign-github-repo-confusion-attack \
            https://arxiv.org/html/2403.04419v1 https://github.com/topics/ai-safety https://github.com/orgs/community/discussions/63603 \
            --validate web5.didcompliance-authority --format structured --encryption $DATA_ENCRYPTION --restrict access-only-verified-nodes
      - name: Upload Validated Data Artifact
        uses: actions/upload-artifact@v3
        with:
          name: validated-data
          path: .workspace/validatedfeeds.json

  threat_intelligence_processing:
    name: Threat Intelligence Processing
    runs-on: ubuntu-latest
    needs: data_ingestion_validation
    steps:
      - name: Download Validated Data
        uses: actions/download-artifact@v3
        with:
          name: validated-data
      - name: Run ALN-based Threat Classifiers
        run: .tools/threatclassifier --input .workspace/validatedfeeds.json --rules config/threatrules.yaml
      - name: Generate Threat Report
        run: .tools/threatreporter --input .workspace/threatscores.json --output .workspace/threatreport.json
      - name: Upload Threat Report
        uses: actions/upload-artifact@v3
        with:
          name: threat-report
          path: .workspace/threatreport.json

  federated_learning:
    name: Federated Model Training
    runs-on: ubuntu-latest
    needs: threat_intelligence_processing
    steps:
      - name: Download Threat Report
        uses: actions/download-artifact@v3
        with:
          name: threat-report
      - name: Run Federated Learning Job
        run: .tools/federatedtrain --model malware-detection-v4 --input .workspace/threatreport.json --privacy differential --update-interval 24h
      - name: Upload Updated Model
        uses: actions/upload-artifact@v3
        with:
          name: updated-model
          path: .workspace/modelstate.bin

  realtime_compliance_monitoring:
    name: Real-Time Compliance Monitoring & Enforcement
    runs-on: ubuntu-latest
    needs: federated_learning
    steps:
      - name: Run Compliance Scanner and Crypto Monitor
        run: |
          .tools/compliancescanner --scan-interval 5m --scan-types codeanalysis,dependencycheck,metadatavalidation --actions alert,quarantine,blockpush
          .tools/cryptomonitor --max-transaction 10000 --risk-level medium --alert-threshold 0.7 --enforce freeze

  audit_and_decision:
    name: Audit Logging & Compliance Decision Engine
    runs-on: ubuntu-latest
    needs: realtime_compliance_monitoring
    steps:
      - name: Record Audit Logs
        run: .tools/auditlogger --timestamp date -u 'Y-m-dTHMSZ' --action reposcan --result latestscanresult.json --actor node0 --proof web5signature --immutable-storage blockchain
      - name: Run Compliance Decision Engine
        run: dotnet run --project decision-engine -- --rules config/compliancerules.yaml

  build_and_deploy:
    name: Build and Deploy ComplianceNexus Artifacts
    runs-on: ubuntu-latest
    needs: audit_and_decision
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Restore Dependencies
        run: dotnet restore ComplianceNexus.sln
      - name: Build Solution
        run: dotnet build ComplianceNexus.sln --configuration Release --no-restore
      - name: Publish Artifacts
        run: dotnet publish ComplianceNexus.sln --configuration Release --output .artifacts --no-build
      - name: Upload Deployment Package
        uses: actions/upload-artifact@v3
        with:
          name: compliance-artifacts
          path: .artifacts
      - name: Deploy to Swarm Network
        run: bash .scripts/deploynanoswarm.sh --security-compliance high --environment production
